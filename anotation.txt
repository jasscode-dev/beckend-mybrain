xp_config :{
    baseTask : 10,
    onTimeBonus :3,
    categoryBonus:{
        WORK :1
        STUDY:2
        BREAK:0
        PERSONAL:0

    }
    xpPerLevel: 200

}


metrics

XP: calculateXpTask 


-- Se Ã© calculo nao guarda no banco 

routine {
  id
  userId
  date
  status
  tasks
}

calculos:{
totalTasks
completedTasks
completionRate
xpEarned
starEarned

}

Controller
  â†“
Service
  - coordena
  - busca dados
  - calcula cenÃ¡rios
  - chama domain
  â†“
Domain
  - valida transiÃ§Ãµes
  - garante invariantes
  â†“
Repository
  - queries eficientes
  - atomicidade


export const RoutineService = (
  routineRepository: IRoutineRepository,
  taskRepository: ITaskRepository
) => {
  return {
    async evaluateRoutine(routineId: string, now: Date) {
      const routine = await routineRepository.findById(routineId)
      if (!routine) throw new Error('Routine not found')

      const { totalTasks, completedTasks } =
        await taskRepository.getRoutineProgress(routineId)

      // ðŸ”¹ decisÃ£o de negÃ³cio
      if (totalTasks === 0) return routine

      if (completedTasks === totalTasks) {
        return routineRepository.update(
          routineId,
          routineDomain.markDone(routine)
        )
      }

      // exemplo: rotina diÃ¡ria expirou
      if (now > endOfDay(routine.date)) {
        return routineRepository.update(
          routineId,
          routineDomain.markFailed(routine)
        )
      }

      return routine
    }
  }
}

export class TaskRepository {
  async getRoutineProgress(routineId: string) {
    const totalTasks = await prisma.task.count({
      where: { routineId }
    })

    const completedTasks = await prisma.task.count({
      where: {
        routineId,
        status: 'DONE'
      }
    })

    return {
      totalTasks,
      completedTasks
    }
  }
}

checkRoutineCompleted: async (routineId: string, userId: string): Promise<boolean> => {
            const routine = await findById(routineId, userId)

            const stats = await repository.getRoutineStats(routine.id, userId)

            if (stats.totalTasks === 0) return false
            if (stats.completedTasks !== stats.totalTasks) return false

            if(routine.status !== 'DONE') {
                await repository.makeDone(routine.id, userId, 'DONE')
                
            }
        },

        async markDoneIfNotFinal(routineId: string, userId: string): Promise<boolean> {
  const result = await prisma.routine.updateMany({
    where: {
      id: routineId,
      userId,
      status: { notIn: ['DONE', 'PARTIAL'] },
    },
    data: { status: 'DONE' },
  })

  return result.count === 1
}
